name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'web/**'
      - '.github/workflows/deploy-pages.yml'
      - 'package.json'
      - 'go.mod'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: ğŸ” Configure base path for Pages
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "NEXT_PUBLIC_BASE_PATH=/${REPO_NAME}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ASSET_PREFIX=/${REPO_NAME}" >> $GITHUB_ENV

      - name: ğŸ“¦ Install dependencies
        working-directory: web
        env:
          NEXT_TELEMETRY_DISABLED: 1
        run: npm ci

      - name: ğŸ—ï¸ Build static site
        working-directory: web
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL || secrets.NEXT_PUBLIC_API_URL || '' }}
        run: npm run build

      - name: ğŸ“Š Generate project stats
        run: |
          echo "ğŸ”¢ Generating project statistics..."

          TOTAL_LINES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" | xargs wc -l | tail -1 | awk '{print $1}')
          GO_FILES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" | wc -l)
          PACKAGES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" -exec dirname {} \; | sort -u | wc -l)
          LAST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%cr)" || echo "No commits")

          mkdir -p web/out/meta

          cat > web/out/meta/stats.json << EOF
          {
            "total_lines": ${TOTAL_LINES:-0},
            "go_files": ${GO_FILES:-0},
            "packages": ${PACKAGES:-0},
            "last_commit": "${LAST_COMMIT}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "version": "v1.0.0"
          }
          EOF

          echo "ğŸ“ˆ Project stats generated:"
          cat web/out/meta/stats.json

      - name: ğŸ” Validate static export
        run: |
          echo "ğŸ” Validating static export..."

          if [ ! -d "web/out" ]; then
            echo "âŒ Static export directory web/out not found!"
            exit 1
          fi

          if [ ! -f "web/out/index.html" ]; then
            echo "âŒ index.html not found in web/out!"
            exit 1
          fi

          if ! grep -q "<title>" web/out/index.html; then
            echo "âŒ Missing title tag in index.html"
            exit 1
          fi

          if ! grep -q "viewport" web/out/index.html; then
            echo "âŒ Missing viewport meta tag"
            exit 1
          fi

          echo "âœ… Static export validation passed"

      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: web/out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“ Create deployment summary
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          echo "## ğŸ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Website URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… **Deployed**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ [Live Website](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± [Mobile View](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”§ [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    steps:
      - name: ğŸ“¢ Notify deployment status
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Website deployed successfully!"
            echo "ğŸ”— URL: https://${{ github.repository_owner }}.github.io/${REPO_NAME}/"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ“ Check the logs for details"
          fi
