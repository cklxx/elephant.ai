name: rfc-autostart-codex

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
    paths:
      - "rfc/**"
      - "**/*RFC*"
      - "**/*rfc*"

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  comment_to_start_codex:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.draft == false }}
    steps:
      - name: Post @codex kickoff comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const { owner, repo } = context.repo;

            const marker = "<!-- codex-autostart:v1 -->";
            const lines = [
              marker,
              "@codex please start a cloud task.",
              "",
              "Context: this PR is an RFC.",
              "Tasks:",
              "1) Read the RFC in this PR and post an execution plan.",
              "2) Split the work into small, independently mergeable PRs with dependencies.",
              "3) Implement the smallest shippable slice first and open a PR.",
              "4) Add/update tests and docs, run full CI, and summarize risks + rollback."
            ];
            const body = lines.join("\n");

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });

            const already = comments.some(c => (c.body || "").includes(marker));
            if (already) return;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body
            });
