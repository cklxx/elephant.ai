name: ğŸ§ª CI Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.mdx"
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: write
  security-events: write

defaults:
  run:
    shell: bash

env:
  GO_VERSION: "1.24.11"
  NODE_VERSION: "20"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸš¦ Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.64.8
          args: --timeout=5m --out-format=colored-line-number

  web:
    name: ğŸŒ Web
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm --prefix web ci

      - name: ğŸ” Web lint
        run: npm --prefix web run lint

      - name: ğŸ§ª Web tests
        run: npm --prefix web run test

      - name: ğŸ—ï¸ Web build
        run: npm --prefix web run build

      - name: ğŸ“Š Bundle analyze
        run: npm --prefix web run analyze

      - name: ğŸ“¦ Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: web-bundle-analyze
          path: web/.next/analyze
          if-no-files-found: error

  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ§ª Run unit tests
        run: go test -race -covermode=atomic -coverprofile=coverage.out ./...

      - name: ğŸ“ Generate coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: â˜ï¸ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html
          if-no-files-found: error

      - name: ğŸ“ˆ Upload to Codecov
        if: env.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ—ï¸ Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p build
          go build -trimpath -ldflags="-w -s" -o "build/alex-${{ matrix.goos }}-${{ matrix.goarch }}" ./cmd/alex

      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: alex-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            build/alex-${{ matrix.goos }}-${{ matrix.goarch }}

  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: alex-linux-amd64
          - os: macos-latest
            artifact: alex-darwin-arm64

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: .

      - name: ğŸ”§ Make binary executable
        run: |
          mv ${{ matrix.artifact }} alex 2>/dev/null || mv alex-* alex
          chmod +x alex

      - name: ğŸ§­ Test CLI commands
        env:
          LLM_PROVIDER: mock
        run: |
          ./alex --help
          ./alex config show
          echo "exit" | ./alex -i

  performance-test:
    name: âš¡ Performance Smoke
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download binary
        uses: actions/download-artifact@v4
        with:
          name: alex-linux-amd64
          path: .

      - name: ğŸ”§ Make binary executable
        run: |
          mv alex-linux-amd64 alex 2>/dev/null || mv alex-* alex
          chmod +x alex

      - name: ğŸ—‚ï¸ Create test files
        run: |
          mkdir -p perf_test
          for i in {1..20}; do
            cat > perf_test/test$i.go << 'EOF'
          package main
          import "fmt"
          func main() { fmt.Println("Hello") }
          func test() int { return 42 }
          EOF
          done

      - name: â±ï¸ Run performance tests
        run: |
          start_time=$(date +%s%N)
          ./alex --help > /dev/null
          end_time=$(date +%s%N)
          duration=$(( (end_time - start_time) / 1000000 ))
          echo "CLI help took ${duration}ms"

          if [ $duration -gt 1000 ]; then
            echo "Performance test failed: CLI too slow (${duration}ms > 1000ms)"
            exit 1
          fi

          start_time=$(date +%s%N)
          ./alex config show > /dev/null
          end_time=$(date +%s%N)
          duration=$(( (end_time - start_time) / 1000000 ))
          echo "Config command took ${duration}ms"

          if [ $duration -gt 500 ]; then
            echo "Performance test failed: Config too slow (${duration}ms > 500ms)"
            exit 1
          fi

  security:
    name: ğŸ”’ Security & Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ” govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.3
          govulncheck ./...

      - name: ğŸ›¡ï¸ gosec (non-blocking)
        continue-on-error: true
        run: |
          curl -sfL https://raw.githubusercontent.com/securecodewarrior/gosec/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          gosec -fmt sarif -out gosec.sarif ./...
          ls -la gosec.* || echo "No gosec output files found"

      - name: â˜ï¸ Upload SARIF (if present)
        if: always() && hashFiles('gosec.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec.sarif

      - name: ğŸ“¦ Verify module tidiness
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âœ… Ensure README exists
        run: test -f README.md

      - name: ğŸ” Spot-check package comments
        run: |
          files=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./.git/*" -not -name "*_test.go")
          missing=$(echo "$files" | xargs -r grep -L "// Package\|// Command" || true)
          if [ -n "$missing" ]; then
            echo "These files might need package-level comments:"
            echo "$missing"
          fi
