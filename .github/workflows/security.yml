name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'

env:
  GO_VERSION: '1.24.11'

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vulnerability-and-static:
    name: ðŸ” Vulnerability & Static Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.3
          govulncheck ./...
        continue-on-error: true

      - name: Run Gosec Security Scanner
        run: |
          curl -sfL https://raw.githubusercontent.com/securecodewarrior/gosec/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          gosec -fmt sarif -out gosec.sarif ./... || echo "Gosec scan completed with issues"
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('gosec.sarif') != ''
        with:
          sarif_file: gosec.sarif

  codeql-analysis:
    name: ðŸ”¬ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: go

      - name: Build
        run: go build -v ./...

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  secrets-scan:
    name: ðŸ” Secrets Scan
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event_name == 'pull_request' && github.event.repository.default_branch || (github.event_name == 'push' && 'HEAD~1' || '') }}
          head: HEAD
          extra_args: --only-verified

  supply-chain-and-license:
    name: ðŸ“¦ Supply Chain & License
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: ./
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Scan SBOM for vulnerabilities
        uses: anchore/scan-action@v3
        with:
          sbom: "sbom.spdx.json"
          severity-cutoff: high
          fail-build: false
        continue-on-error: true

      - name: Check and report licenses
        run: |
          go install github.com/google/go-licenses@latest
          go-licenses check ./... || echo "License check completed with issues"
          go-licenses report ./... > licenses.txt || echo "License report failed"
        continue-on-error: true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.txt
          if-no-files-found: ignore