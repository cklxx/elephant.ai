name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每日凌晨2点运行完整测试
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - api
          - websocket
          - e2e
          - session
          - performance
          - stress
          - load
      coverage:
        description: 'Generate coverage report'
        required: false
        default: true
        type: boolean
      debug:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: "1.21"
  NODE_VERSION: "18"

jobs:
  # 基础环境检查
  environment-check:
    runs-on: ubuntu-latest
    outputs:
      should-run-performance: ${{ steps.check.outputs.performance }}
      should-run-stress: ${{ steps.check.outputs.stress }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check environment
        id: check
        run: |
          echo "performance=${{ github.event_name == 'schedule' || github.event.inputs.test_suite == 'performance' || github.event.inputs.test_suite == 'all' }}" >> $GITHUB_OUTPUT
          echo "stress=${{ github.event_name == 'schedule' || github.event.inputs.test_suite == 'stress' }}" >> $GITHUB_OUTPUT

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Build project
        run: make build

      - name: Validate build
        run: ./alex --version

  # 单元测试和代码质量
  unit-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run unit tests
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic ./internal/...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Code quality checks
        run: |
          go vet ./...
          go fmt ./...
          # 检查是否有未格式化的代码
          if [ "$(go fmt ./... | wc -l)" -gt 0 ]; then
            echo "代码未正确格式化"
            exit 1
          fi

  # API集成测试
  api-integration-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    if: ${{ github.event.inputs.test_suite == 'api' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build project
        run: make build

      - name: Run API integration tests
        run: |
          chmod +x tests/scripts/run-integration.sh
          tests/scripts/run-integration.sh --ci --timeout 15m api
        env:
          ALEX_TEST_COVERAGE: ${{ github.event.inputs.coverage || 'true' }}
          ALEX_TEST_DEBUG: ${{ github.event.inputs.debug || 'false' }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: api-test-results
          path: |
            tests/reports/
            tests/logs/

  # WebSocket集成测试
  websocket-integration-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    if: ${{ github.event.inputs.test_suite == 'websocket' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build project
        run: make build

      - name: Run WebSocket integration tests
        run: |
          chmod +x tests/scripts/run-integration.sh
          tests/scripts/run-integration.sh --ci --timeout 15m websocket
        env:
          ALEX_TEST_COVERAGE: ${{ github.event.inputs.coverage || 'true' }}
          ALEX_TEST_DEBUG: ${{ github.event.inputs.debug || 'false' }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: websocket-test-results
          path: |
            tests/reports/
            tests/logs/

  # 端到端测试
  e2e-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    if: ${{ github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
    strategy:
      matrix:
        test-scenario: [basic, advanced, real-world]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build project
        run: make build

      - name: Run E2E tests
        run: |
          chmod +x tests/scripts/run-integration.sh
          tests/scripts/run-integration.sh --ci --timeout 20m --filter "Test${{ matrix.test-scenario }}*" e2e
        env:
          ALEX_TEST_COVERAGE: ${{ github.event.inputs.coverage || 'true' }}
          ALEX_TEST_DEBUG: ${{ github.event.inputs.debug || 'false' }}
          E2E_SCENARIO: ${{ matrix.test-scenario }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results-${{ matrix.test-scenario }}
          path: |
            tests/reports/
            tests/logs/

  # 性能测试
  performance-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    if: ${{ needs.environment-check.outputs.should-run-performance == 'true' }}
    strategy:
      matrix:
        test-type: [load, benchmark]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build project
        run: make build

      - name: Run performance tests
        run: |
          chmod +x tests/scripts/run-integration.sh
          tests/scripts/run-integration.sh --ci --timeout 30m ${{ matrix.test-type }}
        env:
          ALEX_TEST_COVERAGE: "false"  # 性能测试不需要覆盖率
          ALEX_TEST_DEBUG: ${{ github.event.inputs.debug || 'false' }}

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results-${{ matrix.test-type }}
          path: |
            tests/reports/performance/
            tests/reports/logs/

  # 压力测试 (仅在特定条件下运行)
  stress-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    if: ${{ needs.environment-check.outputs.should-run-stress == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build project
        run: make build

      - name: Run stress tests
        run: |
          chmod +x tests/scripts/run-integration.sh
          tests/scripts/run-integration.sh --ci --timeout 45m stress
        env:
          ALEX_TEST_COVERAGE: "false"
          ALEX_TEST_DEBUG: ${{ github.event.inputs.debug || 'false' }}

      - name: Upload stress test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: stress-test-results
          path: |
            tests/reports/performance/
            tests/reports/logs/

  # 多平台测试
  cross-platform-tests:
    runs-on: ${{ matrix.os }}
    needs: environment-check
    if: ${{ github.event_name == 'schedule' || github.event.inputs.test_suite == 'all' }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: darwin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build project
        run: make build

      - name: Run basic integration tests
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "windows" ]; then
            # Windows特定的测试
            go test -timeout 10m ./tests/integration/api
          else
            # Unix-like系统
            chmod +x tests/scripts/run-integration.sh
            tests/scripts/run-integration.sh --ci --timeout 15m api
          fi
        env:
          ALEX_TEST_COVERAGE: "false"
          ALEX_TEST_DEBUG: "false"

      - name: Upload cross-platform results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cross-platform-test-results-${{ matrix.platform }}
          path: |
            tests/reports/
            tests/logs/

  # 安全测试
  security-tests:
    runs-on: ubuntu-latest
    needs: environment-check
    if: ${{ github.event_name == 'schedule' || github.event.inputs.test_suite == 'all' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Gosec Security Scanner
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gosec.sarif

      - name: Run vulnerability check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  # 集成结果汇总
  integration-summary:
    runs-on: ubuntu-latest
    needs: [
      unit-tests,
      api-integration-tests,
      websocket-integration-tests,
      e2e-tests
    ]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate integration summary
        run: |
          echo "# 集成测试结果摘要" > integration_summary.md
          echo "" >> integration_summary.md
          echo "## 测试状态" >> integration_summary.md
          echo "- 单元测试: ${{ needs.unit-tests.result }}" >> integration_summary.md
          echo "- API集成测试: ${{ needs.api-integration-tests.result }}" >> integration_summary.md
          echo "- WebSocket集成测试: ${{ needs.websocket-integration-tests.result }}" >> integration_summary.md
          echo "- 端到端测试: ${{ needs.e2e-tests.result }}" >> integration_summary.md
          echo "" >> integration_summary.md

          if [ "${{ needs.unit-tests.result }}" = "success" ] &&
             [ "${{ needs.api-integration-tests.result }}" = "success" ] &&
             [ "${{ needs.websocket-integration-tests.result }}" = "success" ] &&
             [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "## ✅ 所有集成测试通过" >> integration_summary.md
          else
            echo "## ❌ 部分集成测试失败" >> integration_summary.md
          fi

      - name: Upload integration summary
        uses: actions/upload-artifact@v3
        with:
          name: integration-summary
          path: integration_summary.md

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('integration_summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # 性能基准线检查
  performance-baseline-check:
    runs-on: ubuntu-latest
    needs: performance-tests
    if: ${{ needs.performance-tests.result == 'success' && (github.event_name == 'pull_request' || github.event_name == 'push') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download performance results
        uses: actions/download-artifact@v3
        with:
          pattern: performance-test-results-*

      - name: Setup Node.js for analysis
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Analyze performance regression
        run: |
          # 创建性能分析脚本
          cat > analyze_performance.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          function analyzePerformance() {
            const resultsDir = './performance-test-results-load';
            const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));

            if (files.length === 0) {
              console.log('没有找到性能测试结果文件');
              return;
            }

            const latestResult = files.sort().pop();
            const results = JSON.parse(fs.readFileSync(path.join(resultsDir, latestResult)));

            console.log('## 性能测试结果分析');
            console.log(`- 平均延迟: ${results.average_latency}`);
            console.log(`- 成功率: ${results.success_rate}%`);
            console.log(`- 请求速率: ${results.requests_per_second} RPS`);
            console.log(`- 内存增长: ${results.memory_growth_mb} MB`);

            // 简单的回归检查
            const baselineFile = './performance_baseline.json';
            if (fs.existsSync(baselineFile)) {
              const baseline = JSON.parse(fs.readFileSync(baselineFile));

              const latencyIncrease = (results.average_latency - baseline.average_latency) / baseline.average_latency * 100;
              const rpsDecrease = (baseline.requests_per_second - results.requests_per_second) / baseline.requests_per_second * 100;

              console.log('\n## 基准线对比');
              console.log(`- 延迟变化: ${latencyIncrease.toFixed(2)}%`);
              console.log(`- RPS变化: ${rpsDecrease.toFixed(2)}%`);

              // 如果性能回归超过10%，标记为警告
              if (latencyIncrease > 10 || rpsDecrease > 10) {
                console.log('\n⚠️ 检测到性能回归');
                process.exit(1);
              }
            }
          }

          analyzePerformance();
          EOF

          node analyze_performance.js

      - name: Update performance baseline
        if: github.ref == 'refs/heads/main'
        run: |
          # 在主分支上更新性能基准线
          echo "更新性能基准线..."
          # 这里应该提取最新的性能数据并更新基准线文件

  # 部署验证 (仅在主分支)
  deployment-validation:
    runs-on: ubuntu-latest
    needs: integration-summary
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release artifacts
        run: make build-all

      - name: Validate release artifacts
        run: |
          echo "验证发布构件..."
          ls -la build/

          # 验证所有平台的二进制文件
          for binary in build/alex-*; do
            if [ -f "$binary" ]; then
              echo "验证 $binary..."
              file "$binary"
            fi
          done

      - name: Upload release artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-artifacts
          path: build/

# 工作流程总结
  workflow-summary:
    runs-on: ubuntu-latest
    needs: [
      unit-tests,
      api-integration-tests,
      websocket-integration-tests,
      e2e-tests,
      performance-tests,
      stress-tests,
      cross-platform-tests,
      security-tests
    ]
    if: always()
    steps:
      - name: Generate workflow summary
        run: |
          echo "# 工作流程执行摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 测试类型 | 状态 |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 单元测试 | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API集成测试 | ${{ needs.api-integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WebSocket集成测试 | ${{ needs.websocket-integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 端到端测试 | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 性能测试 | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 压力测试 | ${{ needs.stress-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 跨平台测试 | ${{ needs.cross-platform-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 安全测试 | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "完整测试报告可在 Actions 的构件中下载。" >> $GITHUB_STEP_SUMMARY