'use client';

import { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';
import { isBrowser } from '@/lib/utils';

export type Language = 'en' | 'zh';

const LANGUAGE_STORAGE_KEY = 'alex.language';

const translations = {
  en: {
    'app.loading': 'Loading console…',
    'language.label': 'Language',
    'language.option.en': 'English',
    'language.option.zh': 'Chinese (Simplified)',
    'language.option.en.short': 'EN',
    'language.option.zh.short': '中',
    'timeline.label': 'Execution timeline',
    'timeline.waiting': 'Waiting for execution to begin',
    'timeline.status.inProgress': 'In progress: {title}',
    'timeline.status.attention': 'Needs attention: {title}',
    'timeline.status.recent': 'Recently completed: {title}',
    'timeline.progress': 'Completed {completed}/{total}',
    'console.brand': 'Alex Console',
    'console.heading.active': 'Session {id}',
    'console.heading.idle': 'New task',
    'console.connection.title': 'Connection',
    'console.connection.subtitle': 'Live status',
    'console.connection.mock': 'Mock stream enabled',
    'console.connection.newConversation': 'Start new conversation',
    'console.settings.title': 'Workspace',
    'console.settings.sessionLabel': 'Current session',
    'console.settings.sessionEmpty': 'None',
    'console.history.title': 'Session history',
    'console.history.subtitle': 'Latest 10 sessions.',
    'console.history.empty': 'No sessions yet.',
    'console.history.pinned': 'Pinned',
    'console.history.recents': 'Recent',
    'console.history.rename': 'Rename session',
    'console.history.renamePlaceholder': 'Session name',
    'console.history.renameConfirm': 'Save name',
    'console.history.renameCancel': 'Cancel rename',
    'console.history.pin': 'Pin session',
    'console.history.unpin': 'Unpin session',
    'console.history.itemPrefix': 'Session {id}',
    'console.quickstart.title': 'Common tasks',
    'console.quickstart.items.code': 'Code & debug',
    'console.quickstart.items.docs': 'Docs & summaries',
    'console.quickstart.items.architecture': 'Architecture reviews',
    'console.thread.sessionPrefix': 'Session {id}',
    'console.thread.newConversation': 'Live feed',
    'console.thread.autosave': 'Autosave on',
    'console.timeline.mobileLabel': 'Timeline snapshot',
    'console.timeline.dialogTitle': 'Execution timeline',
    'console.timeline.dialogDescription': 'Tap a step to focus the matching event.',
    'console.empty.badge': 'Waiting for your task',
    'console.empty.title': 'Ready to take on your work',
    'console.empty.description': 'Submit a task to load history and outputs.',
    'console.input.placeholder.active': 'Add more detail…',
    'console.input.placeholder.idle': 'Type your task…',
    'console.input.hotkeyHint': 'Enter sends · Shift+Enter newline',
    'console.toast.taskFailed': 'Task execution failed',
    'agent.output.heading': 'Agent output',
    'agent.output.tabs.timeline': 'Timeline',
    'agent.output.tabs.events': 'Events',
    'agent.output.tabs.document': 'Document',
    'agent.output.timeline.empty': 'No timeline steps yet',
    'agent.output.document.title': 'Task result',
    'agent.output.document.fallback': 'Task completed successfully',
    'agent.output.document.empty': 'Document will appear when task completes',
    'agent.output.plan.defaultGoal': 'Research and execute task',
    'agent.output.toolOutputs.title': 'Tool outputs',
    'agent.output.toolOutputs.empty': 'No tool outputs yet',
    'agent.output.toolOutputs.emptyHint': 'Results will appear here as tools execute',
    'connection.connected': 'Connected',
    'connection.reconnecting': 'Reconnecting… (Attempt {attempt})',
    'connection.disconnected': 'Disconnected',
    'connection.reconnect': 'Reconnect',
    'document.empty.title': 'No document selected',
    'document.empty.description': 'Document content will appear here',
    'document.view.default': 'Default',
    'document.view.reading': 'Reading',
    'document.view.compare': 'Compare',
    'timeline.card.title': 'Execution Timeline',
    'timeline.card.subtitle': 'Track each step at a glance.',
    'timeline.card.toolsUsed': 'Tools used:',
    'timeline.card.tokensUsed': 'Tokens used:',
    'timeline.card.error': 'Error:',
    'timeline.card.expand': 'Expand details',
    'timeline.card.collapse': 'Collapse details',
    'timeline.card.badge.pending': 'Pending',
    'timeline.card.badge.active': 'In progress',
    'timeline.card.badge.complete': 'Complete',
    'timeline.card.badge.error': 'Failed',
    'plan.title': 'Research Plan',
    'plan.caption.default': 'Review and approve to start execution',
    'plan.caption.readonly': 'Approved plan',
    'plan.collapse': 'Collapse plan',
    'plan.expand': 'Expand plan',
    'plan.goal.label': 'Goal:',
    'plan.steps.label': 'Planned steps ({count}):',
    'plan.iterations': 'Iterations:',
    'plan.tools': 'Tools:',
    'plan.tools.more': '+{count} more',
    'plan.actions.saveChanges': 'Save changes',
    'plan.actions.cancel': 'Cancel',
    'plan.actions.approve': 'Approve & start',
    'plan.actions.modify': 'Modify plan',
    'plan.actions.reject': 'Reject plan',
    'plan.reject.reasonLabel': 'Rejection reason',
    'plan.reject.placeholder': 'Why is this plan not ready to execute?',
    'plan.reject.confirm': 'Confirm rejection',
    'plan.reject.cancel': 'Cancel',
    'plan.edit.goal': 'Edit goal',
    'plan.edit.stepLabel': 'Edit step {index}',
    'plan.move.up': 'Move step {index} up',
    'plan.move.down': 'Move step {index} down',
    'task.submit.title.running': 'Running…',
    'task.submit.title.default': 'Submit (Enter)',
    'task.submit.running': 'Running',
    'task.submit.label': 'Send',
    'task.input.ariaLabel': 'Task input',
    'tool.status.failed': 'Failed',
    'tool.status.completed': 'Completed',
    'tool.toggle.expand': 'Expand output',
    'tool.toggle.collapse': 'Collapse output',
    'tool.toggle.length': ' · {count} characters',
    'tool.section.parameters': 'Parameters',
    'tool.section.error': 'Error',
    'tool.section.output': 'Output',
    'viewport.empty.title': 'No tool outputs yet',
    'viewport.empty.description': 'Results will appear here as tools execute',
    'viewport.title': 'Computer view',
    'viewport.position': '{index} of {total}',
    'viewport.aria.previous': 'Previous output',
    'viewport.aria.next': 'Next output',
    'viewport.aria.enterFullscreen': 'Enter fullscreen mode',
    'viewport.aria.fullscreenViewer': 'Fullscreen tool output viewer',
    'viewport.aria.exitFullscreen': 'Exit fullscreen mode',
    'viewport.fullscreen.close': 'Close',
    'viewport.web.url': 'URL:',
    'viewport.web.screenshot': 'Screenshot',
    'viewport.web.html': 'HTML',
    'viewport.web.screenshotAlt': 'Screenshot',
    'viewport.bash.command': 'Command:',
    'viewport.bash.output': 'Output:',
    'viewport.bash.errorOutput': 'Error output:',
    'viewport.bash.exitCode': 'Exit code:',
    'viewport.diff.split': 'Side by side',
    'viewport.diff.unified': 'Unified',
    'viewport.diff.before': 'Before',
    'viewport.diff.after': 'After',
    'viewport.diff.beforeHeading': '--- Before',
    'viewport.diff.afterHeading': '+++ After',
    'events.empty': 'No events yet. Submit a task to get started.',
    'events.iteration.progress': 'Iteration {iteration} of {total}',
    'events.iteration.complete': 'Iteration {iteration} complete',
    'events.iteration.tokens': '{count} tokens',
    'events.iteration.tools': '{count} tools',
    'events.researchPlan.title': 'Research plan ({count} iterations)',
    'events.step.started': 'Step {index}: {description}',
    'events.step.completed': 'Step {index} complete',
    'events.browserSnapshot.title': 'Browser snapshot',
    'events.browserSnapshot.alt': 'Browser screenshot',
    'events.browserSnapshot.preview': 'View HTML preview',
    'sessions.archiveLabel': 'Session archive',
    'sessions.title': 'Session management',
    'sessions.description': 'Review, revisit, and reopen ALEX automated workflows.',
    'sessions.newConversation': 'Start new conversation',
    'sessions.card.title': 'Session {id}',
    'sessions.card.lastTask': 'Last task',
    'sessions.card.taskCount': '{count} tasks',
    'sessions.card.updated': 'Updated {time}',
    'sessions.card.fork': 'Fork',
    'sessions.card.delete': 'Delete',
    'sessions.card.open': 'Open session',
    'sessions.list.confirmDelete.title': 'Delete session?',
    'sessions.list.confirmDelete.description':
      'This action cannot be undone. All session data will be permanently deleted.',
    'sessions.list.confirmDelete.confirm': 'Delete',
    'sessions.list.confirmDelete.cancel': 'Cancel',
    'sessions.list.toast.deleteSuccess.title': 'Session deleted',
    'sessions.list.toast.deleteSuccess.description': 'The session has been permanently removed.',
    'sessions.list.toast.deleteError.title': 'Failed to delete session',
    'sessions.list.toast.deleteError.description': 'Reason: {message}',
    'sessions.list.toast.forkSuccess.title': 'Session forked successfully!',
    'sessions.list.toast.forkSuccess.description': 'New session ID: {id}…',
    'sessions.list.toast.forkError.title': 'Failed to fork session',
    'sessions.list.toast.forkError.description': 'Reason: {message}',
    'sessions.list.error': 'Error loading sessions: {message}',
    'sessions.list.empty': 'No sessions found. Create a new task to start a session.',
    'sessions.list.loading': 'Loading sessions…',
    'sessions.details.back': 'Back',
    'sessions.details.title': 'Session details',
    'sessions.details.sessionId': 'Session ID: {id}',
    'sessions.details.status.active': 'Active',
    'sessions.details.status.inactive': 'Inactive',
    'sessions.details.info.title': 'Session information',
    'sessions.details.info.created': 'Created',
    'sessions.details.info.updated': 'Last updated',
    'sessions.details.info.taskCount': 'Total tasks',
    'sessions.details.newTask': 'New task',
    'sessions.details.history': 'Task history',
    'sessions.details.history.started': 'Started {time}',
    'sessions.details.history.status.completed': 'Completed',
    'sessions.details.history.status.running': 'Running',
    'sessions.details.history.status.pending': 'Pending',
    'sessions.details.history.status.failed': 'Failed',
    'sessions.details.history.status.in_progress': 'In progress',
    'sessions.details.history.status.error': 'Error',
    'sessions.details.toast.taskStarted.title': 'Task started',
    'sessions.details.toast.taskStarted.description': 'Execution has begun in this session.',
    'sessions.details.toast.taskError.title': 'Failed to execute task',
    'sessions.details.toast.taskError.description': 'Reason: {message}',
    'sessions.details.error': 'Error loading session: {message}',
    'sessions.details.notFound': 'Session not found',
    'sessions.details.loading': 'Loading session…',
    'common.error.unknown': 'Unknown error',
  },
  zh: {
    'app.loading': '加载控制台…',
    'language.label': '语言',
    'language.option.en': '英语',
    'language.option.zh': '简体中文',
    'language.option.en.short': 'EN',
    'language.option.zh.short': '中',
    'timeline.label': '执行时间线',
    'timeline.waiting': '等待执行开始',
    'timeline.status.inProgress': '进行中：{title}',
    'timeline.status.attention': '需要关注：{title}',
    'timeline.status.recent': '最近完成：{title}',
    'timeline.progress': '已完成 {completed}/{total}',
    'console.brand': 'Alex 控制台',
    'console.heading.active': '会话 {id}',
    'console.heading.idle': '新任务',
    'console.connection.title': '连接状态',
    'console.connection.subtitle': '实时状态',
    'console.connection.mock': '模拟流已启用',
    'console.connection.newConversation': '新建对话',
    'console.settings.title': '工作区',
    'console.settings.sessionLabel': '当前会话',
    'console.settings.sessionEmpty': '无',
    'console.history.title': '历史会话',
    'console.history.subtitle': '最近 10 个会话',
    'console.history.empty': '目前还没有历史会话。',
    'console.history.pinned': '置顶',
    'console.history.recents': '最近',
    'console.history.rename': '重命名会话',
    'console.history.renamePlaceholder': '会话名称',
    'console.history.renameConfirm': '保存名称',
    'console.history.renameCancel': '取消重命名',
    'console.history.pin': '置顶会话',
    'console.history.unpin': '取消置顶',
    'console.history.itemPrefix': '会话 {id}',
    'console.quickstart.title': '常用任务',
    'console.quickstart.items.code': '代码与调试',
    'console.quickstart.items.docs': '文档与总结',
    'console.quickstart.items.architecture': '架构评估',
    'console.thread.sessionPrefix': '会话 {id}',
    'console.thread.newConversation': '实时流',
    'console.thread.autosave': '自动保存开启',
    'console.timeline.mobileLabel': '时间线概览',
    'console.timeline.dialogTitle': '执行时间线',
    'console.timeline.dialogDescription': '点按步骤即可定位对应事件。',
    'console.empty.badge': '等待新的任务指令',
    'console.empty.title': '准备好接管你的任务',
    'console.empty.description': '提交任务后会自动填充历史与输出。',
    'console.input.placeholder.active': '继续补充细节…',
    'console.input.placeholder.idle': '请输入任务…',
    'console.input.hotkeyHint': 'Enter 发送 · Shift+Enter 换行',
    'console.toast.taskFailed': '任务执行失败',
    'agent.output.heading': '智能体输出',
    'agent.output.tabs.timeline': '时间线',
    'agent.output.tabs.events': '事件',
    'agent.output.tabs.document': '文档',
    'agent.output.timeline.empty': '暂时没有时间线步骤',
    'agent.output.document.title': '任务结果',
    'agent.output.document.fallback': '任务已成功完成',
    'agent.output.document.empty': '任务完成后将展示文档',
    'agent.output.plan.defaultGoal': '研究并执行任务',
    'agent.output.toolOutputs.title': '工具输出',
    'agent.output.toolOutputs.empty': '暂无工具输出',
    'agent.output.toolOutputs.emptyHint': '工具执行时会在此展示结果',
    'connection.connected': '已连接',
    'connection.reconnecting': '重新连接中…（第 {attempt} 次）',
    'connection.disconnected': '已断开',
    'connection.reconnect': '重新连接',
    'document.empty.title': '尚未选择文档',
    'document.empty.description': '文档内容会显示在这里',
    'document.view.default': '默认',
    'document.view.reading': '阅读',
    'document.view.compare': '对比',
    'timeline.card.title': '执行时间线',
    'timeline.card.subtitle': '快速查看每一步。',
    'timeline.card.toolsUsed': '使用的工具：',
    'timeline.card.tokensUsed': '消耗 Token：',
    'timeline.card.error': '错误信息：',
    'timeline.card.expand': '展开详情',
    'timeline.card.collapse': '收起详情',
    'timeline.card.badge.pending': '待执行',
    'timeline.card.badge.active': '执行中',
    'timeline.card.badge.complete': '已完成',
    'timeline.card.badge.error': '失败',
    'plan.title': '研究计划',
    'plan.caption.default': '审核并批准后开始执行',
    'plan.caption.readonly': '已批准的计划',
    'plan.collapse': '收起计划',
    'plan.expand': '展开计划',
    'plan.goal.label': '目标：',
    'plan.steps.label': '计划步骤（{count}）：',
    'plan.iterations': '迭代次数：',
    'plan.tools': '工具：',
    'plan.tools.more': '+{count} 项',
    'plan.actions.saveChanges': '保存修改',
    'plan.actions.cancel': '取消',
    'plan.actions.approve': '批准并开始',
    'plan.actions.modify': '调整计划',
    'plan.actions.reject': '拒绝计划',
    'plan.reject.reasonLabel': '拒绝原因',
    'plan.reject.placeholder': '为什么该计划无法执行？',
    'plan.reject.confirm': '确认拒绝',
    'plan.reject.cancel': '取消',
    'plan.edit.goal': '编辑目标',
    'plan.edit.stepLabel': '编辑步骤 {index}',
    'plan.move.up': '上移步骤 {index}',
    'plan.move.down': '下移步骤 {index}',
    'task.submit.title.running': '执行中…',
    'task.submit.title.default': '回车提交',
    'task.submit.running': '执行中',
    'task.submit.label': '发送',
    'task.input.ariaLabel': '任务输入框',
    'tool.status.failed': '失败',
    'tool.status.completed': '完成',
    'tool.toggle.expand': '展开输出',
    'tool.toggle.collapse': '收起输出',
    'tool.toggle.length': ' · {count} 字符',
    'tool.section.parameters': '参数',
    'tool.section.error': '错误',
    'tool.section.output': '输出',
    'viewport.empty.title': '暂无工具输出',
    'viewport.empty.description': '工具执行时会在此展示结果',
    'viewport.title': '计算机视图',
    'viewport.position': '第 {index} 项，共 {total} 项',
    'viewport.aria.previous': '上一条输出',
    'viewport.aria.next': '下一条输出',
    'viewport.aria.enterFullscreen': '进入全屏模式',
    'viewport.aria.fullscreenViewer': '全屏工具输出查看器',
    'viewport.aria.exitFullscreen': '退出全屏模式',
    'viewport.fullscreen.close': '关闭',
    'viewport.web.url': '链接：',
    'viewport.web.screenshot': '截图',
    'viewport.web.html': 'HTML',
    'viewport.web.screenshotAlt': '工具截图',
    'viewport.bash.command': '命令：',
    'viewport.bash.output': '输出：',
    'viewport.bash.errorOutput': '错误输出：',
    'viewport.bash.exitCode': '退出码：',
    'viewport.diff.split': '并排查看',
    'viewport.diff.unified': '合并查看',
    'viewport.diff.before': '修改前',
    'viewport.diff.after': '修改后',
    'viewport.diff.beforeHeading': '--- 修改前',
    'viewport.diff.afterHeading': '+++ 修改后',
    'events.empty': '暂无事件。提交任务以开始。',
    'events.iteration.progress': '第 {iteration} 次迭代，共 {total} 次',
    'events.iteration.complete': '第 {iteration} 次迭代完成',
    'events.iteration.tokens': '{count} 个 Token',
    'events.iteration.tools': '{count} 个工具',
    'events.researchPlan.title': '研究计划（{count} 次迭代）',
    'events.step.started': '步骤 {index}：{description}',
    'events.step.completed': '步骤 {index} 已完成',
    'events.browserSnapshot.title': '浏览器快照',
    'events.browserSnapshot.alt': '浏览器截图',
    'events.browserSnapshot.preview': '查看 HTML 预览',
    'sessions.archiveLabel': '会话归档',
    'sessions.title': '历史会话管理',
    'sessions.description': '查看、回溯并重新打开 ALEX 的自动化工作流。',
    'sessions.newConversation': '新建对话',
    'sessions.card.title': '会话 {id}',
    'sessions.card.lastTask': '最近的任务',
    'sessions.card.taskCount': '任务数：{count}',
    'sessions.card.updated': '更新于 {time}',
    'sessions.card.fork': '分叉',
    'sessions.card.delete': '删除',
    'sessions.card.open': '打开会话',
    'sessions.list.confirmDelete.title': '删除会话？',
    'sessions.list.confirmDelete.description': '该操作无法撤销，所有会话数据将被永久删除。',
    'sessions.list.confirmDelete.confirm': '删除',
    'sessions.list.confirmDelete.cancel': '取消',
    'sessions.list.toast.deleteSuccess.title': '会话已删除',
    'sessions.list.toast.deleteSuccess.description': '该会话已被永久移除。',
    'sessions.list.toast.deleteError.title': '删除会话失败',
    'sessions.list.toast.deleteError.description': '原因：{message}',
    'sessions.list.toast.forkSuccess.title': '分叉会话成功！',
    'sessions.list.toast.forkSuccess.description': '新的会话 ID：{id}…',
    'sessions.list.toast.forkError.title': '分叉会话失败',
    'sessions.list.toast.forkError.description': '原因：{message}',
    'sessions.list.error': '加载会话失败：{message}',
    'sessions.list.empty': '没有找到会话。创建一个新任务来开启会话。',
    'sessions.list.loading': '正在加载会话…',
    'sessions.details.back': '返回',
    'sessions.details.title': '会话详情',
    'sessions.details.sessionId': '会话 ID：{id}',
    'sessions.details.status.active': '进行中',
    'sessions.details.status.inactive': '未激活',
    'sessions.details.info.title': '会话信息',
    'sessions.details.info.created': '创建时间',
    'sessions.details.info.updated': '最近更新时间',
    'sessions.details.info.taskCount': '任务总数',
    'sessions.details.newTask': '新建任务',
    'sessions.details.history': '任务历史',
    'sessions.details.history.started': '开始于 {time}',
    'sessions.details.history.status.completed': '已完成',
    'sessions.details.history.status.running': '执行中',
    'sessions.details.history.status.pending': '待处理',
    'sessions.details.history.status.failed': '失败',
    'sessions.details.history.status.in_progress': '执行中',
    'sessions.details.history.status.error': '错误',
    'sessions.details.toast.taskStarted.title': '任务已开始',
    'sessions.details.toast.taskStarted.description': '该会话的执行已经启动。',
    'sessions.details.toast.taskError.title': '执行任务失败',
    'sessions.details.toast.taskError.description': '原因：{message}',
    'sessions.details.error': '加载会话失败：{message}',
    'sessions.details.notFound': '未找到会话',
    'sessions.details.loading': '正在加载会话…',
    'common.error.unknown': '未知错误',
  },
} as const;

export type TranslationKey = keyof typeof translations.en;

type TranslationParams = Record<string, string | number>;

interface LanguageContextValue {
  language: Language;
  setLanguage: (language: Language) => void;
  t: (key: TranslationKey, params?: TranslationParams) => string;
}

const LanguageContext = createContext<LanguageContextValue | null>(null);

const languageLocaleMap: Record<Language, string> = {
  en: 'en-US',
  zh: 'zh-CN',
};

export function getLanguageLocale(language: Language): string {
  return languageLocaleMap[language] ?? 'en-US';
}

function format(template: string, params?: TranslationParams) {
  if (!params) return template;
  return template.replace(/\{(\w+)\}/g, (_, token: string) => {
    const value = params[token];
    return value !== undefined ? String(value) : `{${token}}`;
  });
}

export function LanguageProvider({ children }: { children: React.ReactNode }) {
  const [language, setLanguageState] = useState<Language>('en');

  useEffect(() => {
    if (!isBrowser()) return;

    const stored = window.localStorage.getItem(LANGUAGE_STORAGE_KEY);
    if (stored === 'en' || stored === 'zh') {
      setLanguageState((current) => (current === stored ? current : stored));
      return;
    }

    const browserLanguage = window.navigator.language?.toLowerCase();
    if (browserLanguage && browserLanguage.startsWith('zh')) {
      setLanguageState((current) => (current === 'zh' ? current : 'zh'));
    }
  }, []);

  useEffect(() => {
    if (!isBrowser()) return;

    document.documentElement.lang = language === 'zh' ? 'zh-Hans' : 'en';
    window.localStorage.setItem(LANGUAGE_STORAGE_KEY, language);
  }, [language]);

  const translate = useCallback(
    (key: TranslationKey, params?: TranslationParams) => {
      const dictionary = translations[language];
      const fallback = translations.en;
      const template = (dictionary[key] ?? fallback[key]) as string;
      return format(template, params);
    },
    [language]
  );

  const setLanguage = useCallback((nextLanguage: Language) => {
    setLanguageState(nextLanguage);
  }, []);

  const value = useMemo<LanguageContextValue>(
    () => ({
      language,
      setLanguage,
      t: translate,
    }),
    [language, setLanguage, translate]
  );

  return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
}

export function useI18n() {
  const context = useContext(LanguageContext);
  if (!context) {
    throw new Error('useI18n must be used within a LanguageProvider');
  }
  return context;
}

export function useTranslation() {
  const { t } = useI18n();
  return t;
}

export const supportedLanguages = [
  {
    code: 'en' as const,
    labelKey: 'language.option.en' as TranslationKey,
    shortKey: 'language.option.en.short' as TranslationKey,
  },
  {
    code: 'zh' as const,
    labelKey: 'language.option.zh' as TranslationKey,
    shortKey: 'language.option.zh.short' as TranslationKey,
  },
];
