# Alex 工作台产品需求文档（PRD）

## 一、产品背景
Alex 已经具备用户体系、会话记录和 crafts 产物管理能力，但在实际使用中，创作者面对的任务类型日益多样。需要一个集中式工作台，让用户按照目标类型（图片、文章、网页、代码微服务 demo）快速进入合适的创作环境，并让 Agent 在过程中提供资料检索、协作执行等能力。

## 二、产品目标
1. 提供统一入口，支持用户一键选择目标类型并启动对应创作流程。
2. 保证文章场景具备所见即所得的编辑体验，并可查看 Agent 在沙箱中的实时动作。
3. 为每种目标预留扩展位，便于后续补充专属工具或自动化流程。
4. 与现有 crafts 模块、用户体系无缝衔接，所有产物与用户会话保持一致的权限控制。

## 三、核心用户故事
- **作为创作者**，我希望登录后可以看到一个简洁的工作台，了解可执行的目标类型，并快速开始。
- **作为写作者**，我需要一个 WYSIWYG 编辑器，可以专注撰写、插入图片或引用，同时获取 Agent 自动提供的背景资料与可行动建议。
- **作为工程师/设计师**，我希望随时看到 Agent 在沙箱中的执行情况，以便理解其步骤并进行协作。
- **作为产品运营**，我期望所有产物都自动保存到 crafts 中，便于复盘与下载。

## 四、功能需求
### 4.1 工作台主页
- 列出四种工作目标：图片、文章、网页、代码微服务（demo）。
- 每个目标提供简介、典型场景、进入按钮。
- 展示最近在该目标下的产物概览（预留）。

### 4.2 文章工作台
- 提供所见即所得的编辑区，支持基础格式：标题、段落、粗体、斜体、列表。
- 支持从剪贴板粘贴文本与图片。
- 右侧/下方展示 AI 辅助区域，包括：
  - Agent 自动补充的资料摘要、行动建议。
  - 推荐可插入文中的引用或图片。
- Agent 在生成插图建议时会自动调用 Seedream 渲染图像，并在面板中展示预览与下载入口，同时同步到 Crafts 供后续复用。
- 页面右下角嵌入 iframe，展示沙箱中的 Agent 操作（默认指向已存在的 web docker 界面）。
- 支持一键将当前草稿保存为 Crafts 产物，并可复用同一会话持续写作。
- 草稿历史面板展示已保存的 Crafts 草稿，支持一键载入编辑器继续撰写。
- 草稿历史面板支持删除不再需要的草稿，删除后自动从列表与 Crafts 中清理。
- 保存、导出动作接入 crafts 管道（后续迭代）。

### 4.3 图片工作台
- 支持输入创作简报、偏好风格与参考素材，调用 Agent 生成 Seedream 友好的多组提示词及补充要点。
- 显示生成的画幅建议、种子提示，支持一键复制提示词至剪贴板。
- 展示 Agent 沙箱 iframe，观察其在后台的迭代过程。

### 4.4 网页工作台
- 提供表单收集页面目标、受众、语气以及必须包含的要素。
- Agent 返回结构化的页面蓝图：页面标题、摘要、模块划分、组件建议、文案要点、CTA 和 SEO 关键词。
- 支持一键复制 JSON 蓝图、单独复制模块文案，并在右侧显示沙箱 iframe。

### 4.5 代码微服务工作台
- 收集服务名称、业务目标、首选语言以及关键功能/集成，调用 Agent 输出结构化微服务蓝图。
- 蓝图包含架构要点、组件职责、API 端点（含请求/响应草稿）、开发任务、运维建议与测试策略。
- 支持一键复制架构摘要或单个端点定义，配合 crafts 同步与 sandbox iframe 观察 Agent 操作。
- 表单采用预设语言快捷按钮，可灵活补充自定义技术栈与依赖。

### 4.5 权限与安全
- 仅登录用户可访问工作台及其子页面。
- iframe 使用只读模式加载 Agent 沙箱视图，避免越权操作。

## 五、非功能需求
- UI 与现有 Alex 品牌视觉保持一致（暗背景、卡片式布局）。
- 页面需兼容桌面端 Chrome/Edge，响应式优先级次于桌面体验。
- iframe 默认高度不超过 320px，避免遮挡主要工作区。

## 六、上线验收标准
1. 工作台主页可列出四个目标并正确跳转到文章/图片工作台。
2. 文章工作台支持格式化工具栏、编辑内容自动保存到内存状态。
3. 图片工作台能够提交创作简报，生成至少 1 组提示词并允许复制。
4. iframe 能根据配置展示 Agent 沙箱界面（支持默认占位）。
5. 网页工作台提交后会渲染至少 2 个模块建议，并可复制 JSON 蓝图。
6. 草稿历史面板的删除操作会即时更新列表，并能在 UI 中看到成功提示。
7. 相关代码通过 `npm run lint` 与 `npm run test`（或现有测试套件）。
8. 保存草稿后可在 sandbox 的 `/workspace/crafts` 看到对应目录与 `metadata.json`，删除草稿时目录被清理。
9. 代码工作台提交后会渲染至少一个组件与 API 端点，并允许复制端点定义。

---

# 技术方案

## 1. 路由与页面结构
- 新增 `web/app/workbench/page.tsx` 作为工作台入口；`web/app/page.tsx` 重定向至 `/workbench`。
- 为不同目标预留子路由：`/workbench/article`、`/workbench/image`、`/workbench/web`、`/workbench/code`。
- 文章场景提供实际页面 `web/app/workbench/article/page.tsx`，其余暂返回引导占位。

## 2. 文章工作台实现
- 使用 React Client 组件实现一个基础 WYSIWYG：
  - 利用 `contentEditable` 与 `document.execCommand` 处理格式化。
  - 通过 `useState` 保存 HTML 内容，并在工具栏操作后同步。
  - 提供格式按钮组件 `RichTextToolbar`，使用 `lucide-react` 图标。
- 引入 AI 辅助面板组件：
  - 读取当前上下文（后续可接入后端 API）。
  - 当前版本提供提示内容与下一步扩展位。
- iframe 组件从 `process.env.NEXT_PUBLIC_SANDBOX_VIEWER_URL` 读取地址，fallback 到默认 URL。

## 3. 样式与交互
- 使用 Tailwind CSS 构建卡片和布局，确保符合现有暗色风格。
- toolbar 按钮通过 `aria-pressed` 表示状态，符合可访问性标准。
- iframe 容器固定在右下角，带阴影与圆角；在移动端改为底部全宽浮层（后续迭代）。

## 4. 状态管理与扩展
- 文章编辑内容暂存于组件状态，后续可通过 React Query 与后台同步。
- 预留 `useEffect` 钩子监听内容变化并触发保存/产物上传流程。

## 5. 网页工作台实现
- 后端在 `WorkbenchService` 中实现 `GenerateWebBlueprint`，负责清洗输入、拼装 Prompt、解析 Agent JSON，并在解析失败时落回模板蓝图。
- `internal/server/http` 暴露 `POST /api/workbench/web/blueprint`，仅允许已认证用户访问，并对缺少目标或解析失败的请求返回明确错误码与信息。
- `web/lib/api.ts` 增加 `generateWebBlueprint` 方法与类型，供客户端统一调用，并确保错误信息透传到 UI。
- 前端页面 `web/app/workbench/web/page.tsx` 渲染表单、结果展示、复制按钮与沙箱 iframe；在测试环境回退到 `about:blank`，避免 Vitest 触发真实网络请求。

## 6. 测试与质量
- 为 `WorkTypeCard`、文章、图片与网页工作台分别编写渲染及交互测试（Vitest + Testing Library），覆盖复制、保存、表单提交流程。
- 后端新增 Workbench Service 与 HTTP 层单元测试，验证多种输入、错误路径及 JSON 解析边界。
- 前端命令：`npm run lint`、`npm run test`。
- 确认 `go test ./...` 仍通过，确保后端改动无影响。

## 7. 发布步骤
1. 合并文档与前端代码改动。
2. 运行全部测试与 lint。
3. 通过 CI 部署，验证工作台和文章页面在实际环境的 iframe 加载情况。

