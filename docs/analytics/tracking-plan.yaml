version: 1
owner: console-team
updated_at: 2024-12-02

events:
  - event: task_submitted
    description: 用户在会话输入框提交任务
    source: web
    properties:
      - name: session_id
        type: string
        required: false
        description: 当前会话 ID，若为新会话则为空
      - name: has_active_session
        type: boolean
        required: true
        description: 提交前是否已有激活会话
      - name: attachment_count
        type: number
        required: true
        description: 本次提交包含的附件数量
      - name: has_attachments
        type: boolean
        required: true
      - name: input_length
        type: number
        required: true
        description: 文本输入字符数，用于监控极端长输入
      - name: mock_stream
        type: boolean
        required: true
        description: 是否在本地使用 mock SSE
      - name: prefill_present
        type: boolean
        required: true
        description: 提交前是否存在预填充任务

  - event: task_submission_failed
    description: 前端创建任务失败（HTTP 或客户端校验）
    source: web
    properties:
      - name: session_id
        type: string
        required: false
      - name: is_api_error
        type: boolean
        required: true
      - name: status_code
        type: number
        required: false
      - name: mock_stream
        type: boolean
        required: true

  - event: task_retried_without_session
    description: 后端返回 404 后，前端剔除失效会话并重试
    source: web
    properties:
      - name: session_id
        type: string
        required: true
      - name: error_status
        type: number
        required: true
      - name: mock_stream
        type: boolean
        required: true

  - event: task_cancel_requested
    description: 用户或后端请求取消任务
    source: multi
    properties:
      - name: session_id
        type: string
        required: false
      - name: task_id
        type: string
        required: false
      - name: status
        type: string
        required: true
        description: initiated/success/dispatched/no_active_execution
      - name: mock_stream
        type: boolean
        required: false
      - name: request_state
        type: string
        required: false
        description: 前端标记 inflight / queued
      - name: cancel_fn_found
        type: boolean
        required: false
        description: 服务端是否找到正在执行的任务
      - name: requested_by
        type: string
        required: false

  - event: task_cancel_failed
    description: 取消失败（前端 API 调用报错）
    source: web
    properties:
      - name: session_id
        type: string
        required: false
      - name: task_id
        type: string
        required: false
      - name: error_kind
        type: string
        required: true
      - name: status_code
        type: number
        required: false

  - event: task_execution_started
    description: 服务端确认任务入队
    source: server
    properties:
      - name: session_id
        type: string
        required: true
      - name: task_id
        type: string
        required: true
      - name: level
        type: string
        required: false
      - name: has_parent_task
        type: boolean
        required: true
      - name: parent_task_id
        type: string
        required: false
      - name: attachment_count
        type: number
        required: true
      - name: has_attachments
        type: boolean
        required: true

  - event: task_execution_completed
    description: 服务端任务执行成功
    source: server
    properties:
      - name: session_id
        type: string
        required: true
      - name: task_id
        type: string
        required: true
      - name: duration_ms
        type: number
        required: true
      - name: iterations
        type: number
        required: true
      - name: parent_task_id
        type: string
        required: false
      - name: agent_preset
        type: string
        required: false
      - name: tool_preset
        type: string
        required: false
      - name: stop_reason
        type: string
        required: false

  - event: task_execution_failed
    description: 服务端任务执行失败
    source: server
    properties:
      - name: session_id
        type: string
        required: true
      - name: task_id
        type: string
        required: true
      - name: duration_ms
        type: number
        required: true
      - name: error
        type: string
        required: true
      - name: parent_task_id
        type: string
        required: false
      - name: agent_preset
        type: string
        required: false
      - name: tool_preset
        type: string
        required: false

  - event: task_execution_cancelled
    description: 服务端确认任务取消
    source: server
    properties:
      - name: session_id
        type: string
        required: true
      - name: task_id
        type: string
        required: true
      - name: duration_ms
        type: number
        required: true
      - name: termination_reason
        type: string
        required: true
      - name: parent_task_id
        type: string
        required: false
      - name: agent_preset
        type: string
        required: false
      - name: tool_preset
        type: string
        required: false

  - event: session_created
    description: 前端清空当前会话并准备新对话
    source: web
    properties:
      - name: previous_session_id
        type: string
        required: false
      - name: had_active_session
        type: boolean
        required: true
      - name: history_count
        type: number
        required: true
      - name: pinned_count
        type: number
        required: true

  - event: session_selected
    description: 用户在侧栏切换会话
    source: web
    properties:
      - name: session_id
        type: string
        required: true
      - name: previous_session_id
        type: string
        required: false
      - name: was_pinned
        type: boolean
        required: true
      - name: was_in_history
        type: boolean
        required: true

  - event: session_deleted
    description: 用户删除会话
    source: web
    properties:
      - name: session_id
        type: string
        required: true
      - name: status
        type: string
        required: true
        description: success / error
      - name: error_kind
        type: string
        required: false
      - name: status_code
        type: number
        required: false

  - event: sidebar_toggled
    description: 左侧会话列表展开/收起
    source: web
    properties:
      - name: previous_state
        type: string
        required: true
      - name: next_state
        type: string
        required: true

  - event: timeline_viewed
    description: 移动端打开执行时间线抽屉
    source: web
    properties:
      - name: session_id
        type: string
        required: false
      - name: step_count
        type: number
        required: true

  - event: auto_review_continue
    description: 内部回放中在自动评审卡片选择「继续完成」
    source: web
    properties:
      - name: session_id
        type: string
        required: true
        description: 触发操作的会话 ID
      - name: task_id
        type: string
        required: false
        description: 相关自动评审事件的任务 ID
      - name: has_notes
        type: boolean
        required: true
        description: 自动评审是否提供了未完成内容备注

  - event: auto_review_continue_with_notes
    description: 内部回放中在自动评审卡片选择「继续完成并标注未完成内容」
    source: web
    properties:
      - name: session_id
        type: string
        required: true
        description: 触发操作的会话 ID
      - name: task_id
        type: string
        required: false
        description: 相关自动评审事件的任务 ID
      - name: has_notes
        type: boolean
        required: true
        description: 自动评审是否提供了未完成内容备注
