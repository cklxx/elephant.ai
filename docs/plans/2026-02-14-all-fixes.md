# Plan: 全部修复（架构/代码/测试/DevOps）

Date: 2026-02-14  
Owner: Codex
Branch: `fix/all-issues-20260214`

## Scope
- 修复本轮评估中确认的 5 个关键问题簇：
  1. 本地 CI 门禁与云端 CI 不一致
  2. 架构分层违规（app -> infra/markdown）
  3. Scheduler 多入口重复执行风险（缺少 single-leader）
  4. Lark 长生命周期 map/queue 缺少 TTL/cap/sweeper
  5. Eval Gate 软门禁（PR 不阻断）

## Constraints
- 不改产品行为语义（除上述风险点）
- 保持 YAML 配置风格与现有兼容
- 增量提交，先低风险后高风险

## Execution Steps

### Step 1: 流程门禁修复（已完成）
- [x] 对齐 `scripts/pre-push.sh` 与 CI：加入 `check-arch-policy` 与 Go test gate
- [x] 修正 `scripts/check-arch.sh` 子包匹配缺陷
- [x] 将 eval PR gate 改为硬门禁（移除 `continue-on-error`）

### Step 2: 分层违规修复（已完成）
- [x] 将 `internal/infra/markdown` 迁移到 `internal/shared/markdown`
- [x] 更新 `kernel`/`di` 引用与相关测试导入
- [x] 确认 `make check-arch-policy` 归零

### Step 3: Scheduler single-leader（已完成）
- [x] 基于 Postgres advisory lock 增加 leader guard
- [x] 在 server/lark 两入口统一接入（通过 bootstrap scheduler 统一入口）
- [x] 增加 leader lock 覆盖测试（acquire/retry/release/context）

### Step 4: Lark 生命周期清理（已完成）
- [x] 为 `activeSlots` / `pendingInputRelays` 增加 TTL + cap + sweeper
- [x] 接入 `aiCoordinator.CleanupExpiredSessions`
- [x] 增加单测覆盖过期与容量裁剪

### Step 5: 验证、审查、提交与回合并（进行中）
- [x] 运行完整 lint/test（Go + Web）
- [x] 执行 mandatory code review（按 skill checklist）
- [ ] 分批提交并合并回 `main`
- [ ] 删除临时 worktree

## Progress Log
- 2026-02-14 00:03: 创建计划文件，开始 Step 1。
- 2026-02-14 00:15: 完成 Step 1（pre-push + arch gate + eval gate）。
- 2026-02-14 00:27: 完成 Step 3（scheduler leader lock + tests）。
- 2026-02-14 00:42: 完成 Step 4（Lark TTL/cap/sweeper + tests + config wiring）。
- 2026-02-14 00:56: 完成全量 `pre-push` 验证与 mandatory review，进入提交与回合并阶段。
- 2026-02-14 01:18: 修复 main 演进后的 arch-policy 基线问题（markdown 包迁移到 shared），门禁恢复全绿。
