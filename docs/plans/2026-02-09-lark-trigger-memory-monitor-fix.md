# 2026-02-09 Lark 触发/记忆/监控修复计划

Owner: Codex CLI agent  
Status: In Progress

## 背景
cklxx 反馈 Lark 链路存在三类问题：
1. 一条消息可能触发多次回复；
2. 上一条消息执行中会触发新一轮 agent 消息；
3. 记忆召回命中后执行目标不聚焦；
4. “看看代码助手在做什么”缺少可直接使用的入口（尽管底层 hooks/monitor 已接入）。

## 目标
- 收敛 Lark 消息执行的并发与回合推进，避免重复触发。
- 强化历史召回对“当前任务”的约束，提升可执行性。
- 提供自然语言可达的代码助手状态查看能力，复用现有任务/进度体系。

## 实施步骤
- [x] 代码定位与根因确认（Gateway/AI coordinator/history recall/bg status）。
- [x] 修复 AI chat 回合推进重复调用与错误触发路径。
- [x] 调整 in-flight 消息重放策略，避免执行中输入导致额外轮次。
- [x] 修复历史召回摘要 prompt 未使用当前任务的问题，并补充约束。
- [x] 增加自然语言“状态查询”路由到任务状态输出。
- [x] 补充/更新单元测试（TDD for touched logic）。
- [x] 运行 full lint + full tests。
- [x] 执行强制代码评审流程（skills/code-review）。
- [ ] 增量提交并合并回 main，清理 worktree。

## 风险与回滚
- 风险：过度抑制消息重放可能丢失真实 follow-up。
- 缓解：仅在非 await_user_input 场景抑制重放；await 场景保持重放。
- 回滚：每个修复以独立提交落地，可单独回退。

## 进度日志
- 2026-02-09 14:30 +0800：完成根因定位，开始实现与测试。
- 2026-02-09 14:55 +0800：完成三条修复实现与新增单测，定向与包级测试通过。
- 2026-02-09 15:08 +0800：完成全量 lint/test 与代码评审，无新增阻塞问题。
