# Performance & Code Quality Round 2

Updated: 2026-01-31

## Scope

Follow-up from round 1. Targets: tool_batch, workflow_event_translator, history_manager, lark gateway.

---

## Batch 6: tool_batch lock contention (R2-P1, R2-P2)

### Files: `internal/agent/domain/react/tool_batch.go`, `placeholders.go`

**R2-P1 — Reduce stateMu lock scope in runCall**

Move `normalizeImportantNotes` extraction outside the lock. Only hold the lock for the final map writes to `state.Important`.

**R2-P2 — Cache state IDs in runCall**

Cache `b.state.SessionID`, `b.state.RunID`, `b.state.ParentRunID` in local variables at `runCall` entry to avoid repeated shared-state dereferences across goroutines.

---

## Batch 7: workflow_event_translator (R2-P3, R2-P4, R2-Q1)

### Files: `internal/agent/app/coordinator/workflow_event_translator.go`

**R2-P3 — Normalize tool name once in buildArtifactManifestPayload**

`strings.EqualFold(strings.TrimSpace(e.ToolName), ...)` is called multiple times. Normalize once to lowercase, then use `==`.

**R2-P4 — Single-pass sanitizeWorkflowSnapshot**

Eliminate the intermediate `orderSet` map. Build `filteredNodes` and `filteredOrder` in one pass using a set derived from filtered nodes directly.

**R2-Q1 — Bound subflowStatsTracker.flows**

Add automatic cleanup: when a subflow is fully completed (all tasks done), remove its entry from the `flows` map.

---

## Batch 8: history_manager (R2-P5)

### Files: `internal/context/history_manager.go`

**R2-P5 — Replace reflect.DeepEqual with manual field comparison**

Replace 5 `reflect.DeepEqual` calls with type-specific comparison:
- `Thinking` → compare Parts slices field by field
- `Metadata` → compare map[string]any manually
- `Arguments` → compare map[string]any manually
- `Attachments` → compare struct fields directly

---

## Batch 9: Lark gateway Q7 (R2-Q2)

### Files: `internal/channels/lark/gateway.go`

**R2-Q2 — Unify sendMessage/replyMessage into single dispatch**

Replace the 6 symmetric methods (send/reply × plain/typed/typedWithID) with a single internal `dispatchMessage` method parameterized by target (chatID vs messageID).

---

## Execution Order

1. Batch 6 (tool_batch) — independent
2. Batch 7 (translator) — independent
3. Batch 8 (history_manager) — independent
4. Batch 9 (lark gateway) — independent

All batches are independent. Each gets its own commit.
