# Performance & Code Quality Round 2

Updated: 2026-01-31

## Scope

Follow-up from round 1. Targets: tool_batch, workflow_event_translator, history_manager, lark gateway.

**Status: COMPLETE** — All 7 items fixed across 4 batches.

---

## Batch 6: tool_batch lock contention (R2-P1, R2-P2) — DONE

### Files: `internal/agent/domain/react/tool_batch.go`, `placeholders.go`

**R2-P1 — Reduce stateMu lock scope in runCall** DONE

Split `applyImportantNotes` into `extractImportantNotes` (pure, lock-free) and `mergeImportantNotes` (state mutation under lock).

**R2-P2 — Cache state IDs in runCall** DONE

Cached `SessionID`, `RunID`, `ParentRunID` in local variables at `runCall` entry.

---

## Batch 7: workflow_event_translator (R2-P3, R2-P4, R2-Q1) — DONE

### Files: `internal/agent/app/coordinator/workflow_event_translator.go`

**R2-P3 — Normalize tool name once in buildArtifactManifestPayload** DONE

Normalized once to lowercase, replaced `strings.EqualFold` with `==`.

**R2-P4 — Single-pass sanitizeWorkflowSnapshot** DONE

Merged node filtering, retained-set building, and summary counting into one pass.

**R2-Q1 — Bound subflowStatsTracker.flows** DONE

Auto-delete completed subflow entries when `completed >= total`.

---

## Batch 8: history_manager (R2-P5) — DONE

### Files: `internal/context/history_manager.go`

**R2-P5 — Replace reflect.DeepEqual with manual field comparison** DONE

Replaced 5 `reflect.DeepEqual` calls with `thinkingEqual`, `attachmentEqual`, `mapStringAnyEqual`, and `anyValueEqual`. Removed `reflect` import entirely.

---

## Batch 9: Lark gateway (R2-Q2) — DONE

### Files: `internal/channels/lark/gateway.go`, `progress_listener.go`

**R2-Q2 — Unify sendMessage/replyMessage into single dispatch** DONE

Replaced 6 symmetric methods with `dispatchMessage` (returns ID) + `dispatch` (fire-and-forget) + `replyTarget` helper. Net -71 lines.

---

## Execution Order

1. Batch 6 (tool_batch) — DONE (commit ba1f3b90)
2. Batch 7 (translator) — DONE (commit 2eae9cdc)
3. Batch 8 (history_manager) — DONE (commit e1e0bf20)
4. Batch 9 (lark gateway) — DONE (commit 7cca15d5)

All batches verified: `go build ./...`, `go vet ./...`, `go test ./...` pass.
