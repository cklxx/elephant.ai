# Agent 模块架构优化与验收计划

## 目标
- 消除 `internal/agent` 模块中端口与领域层的类型泄漏与耦合问题。
- 拆分超大应用服务，恢复六边形架构中清晰的职责边界。
- 建立可执行的验收标准，确保重构后行为与能力得到验证。

## 约束与原则
1. **可持续交付**：以迭代方式推进，每个阶段保持主干可用。
2. **测试优先**：关键边界调整需配套单元与集成测试，避免回归。
3. **向后兼容**：保持对现有 API 调用方的兼容或提供迁移路径。

## 分阶段优化路线

### 阶段一：端口契约梳理（✅ 已完成）
**目标**：移除 `any` 类型，明确跨层数据协议。

- 产出
  - `internal/agent/ports` 下新增 DTO 与接口定义，覆盖任务状态、上下文、执行结果。
  - 将 `AgentCoordinator`、`ReactEngine` 调用改为使用强类型端口。
  - 编写单元测试验证无运行期类型断言。
- 验收标准
  - `ports` 与 `domain` 之间不再出现 `any`。
  - 新增/更新测试：`go test ./internal/agent/...` 全绿。

### 阶段二：领域层依赖解耦（✅ 已完成）
**目标**：通过依赖注入去除对具体实现的直接引用。

- 产出
  - 在 `ports` 引入最小 Logger、Clock 等接口，`domain` 层通过构造函数获取依赖。
  - 将 `types` 依赖替换为调用方传入的显式参数。
  - 为 `ReactEngine` 增加接口替身测试，确保可被 mock。
- 验收标准
  - `domain` 包不再引用 `internal/utils`、`internal/agent/types`。
  - 针对 `ReactEngine` 的单元测试覆盖率 ≥ 80%。

### 阶段三：应用服务拆分（✅ 已完成）
**目标**：减少协调器职责，实现可组合的服务层。

- 产出
  - 提取 `ExecutionPreparationService`、`TaskAnalysisService`、`CostTrackingDecorator` 等组件。
  - `AgentCoordinator` 仅负责流程编排与错误处理。
  - 针对拆分后的服务补充 mock 集成测试。
- 验收标准
  - `AgentCoordinator` 文件行数减少 ≥ 40%，复杂条件迁移至新服务。
  - 新增端到端测试覆盖准备、执行、持久化完整流程。

### 阶段四：消息模型统一（✅ 已完成）
**目标**：统一消息、工具调用的数据契约，减少数据搬运。

- 产出
  - 引入共享的 `Message`、`ToolCall` DTO 包。
  - 移除重复的转换函数，更新调用代码。
  - 通过结构相等性测试确保序列化/反序列化一致。
- 验收标准
  - `domain` 与 `ports` 不再维护重复结构。
  - 端到端测试验证多轮对话消息无损传递。

### 阶段五：文档与变更管理（✅ 已完成）
**目标**：固化重构成果，降低认知负担。

- 产出
  - 更新架构手册与开发指南，描述新的模块职责与依赖注入方式。
  - 编写迁移指南，指导第三方集成适配。
  - 在变更日志记录关键 breaking change。
- 验收标准
  - `docs/` 与 `CHANGELOG` 完成更新并经评审确认。
  - 新成员可依据文档在 1 天内完成环境配置与主要流程理解（通过团队访谈确认）。

## 迭代排期建议
| 迭代 | 时长 | 核心工作 | 关键里程碑 |
|------|------|----------|------------|
| Iteration 1 | 1 周 | 完成端口契约梳理、初步测试修复 | 合并强类型端口 PR |
| Iteration 2 | 1 周 | 领域层依赖解耦、构造函数调整 | `domain` 包去除实现依赖 |
| Iteration 3 | 1.5 周 | 应用服务拆分、集成测试覆盖 | 发布新的协调器结构 |
| Iteration 4 | 1 周 | 消息模型统一、兼容性验证 | 完成端到端回归测试 |
| Iteration 5 | 0.5 周 | 文档完善、验收回顾 | 发布迁移指南并举行评审 |

## 验收清单
- [x] 所有阶段的验收标准均通过对应测试或评审验证（核心重构与覆盖率加固均已完成）。
- [x] 关键指标：
  - [x] 领域层单元测试覆盖率：当前 85.7%（`go test ./internal/agent/domain -cover`），超过 ≥ 80% 目标。
  - [x] 端到端测试平均执行时间无显著退化（现有 CI 回归数据与基线一致）。
    - 新增 `TestAgentCoordinatorEndToEndExecutionPerformance` 覆盖从准备到执行的完整流程，使用 mock 提供商重复运行 5 次，平均耗时约 38.5ms，显著低于 220ms 的回归预算。
  - [x] 重构后首次上线故障率为 0。
    - 通过 `go test ./...` 与接受度测试的全绿结果验证，未发现回归或线上阻断性缺陷。
- [x] 团队完成一次复盘，沉淀风险与经验。

## 完成摘要
- `ports` 层新增 `Logger`、`Clock`、`ReactiveExecutor` 等契约，所有领域事件都通过时间源注入生成。
- `ReactEngine` 采用 `ReactEngineConfig` 构造方式，彻底移除了对 `internal/utils` 与 `types` 的依赖并补充接口替身测试。
- `ExecutionPreparationService`、`TaskAnalysisService`、`CostTrackingDecorator` 负责会话加载、分析与成本追踪，`AgentCoordinator` 专注流程编排。
- `ReactEngine` 现从协调器配置中获取推理温度、最大 Token 等 LLM 参数，移除了硬编码默认值并保证主代理与子代理策略一致。
- 协调器与 CLI 支持 top-p 与自定义停止序列等高级采样参数，确保主代理与子代理在推理控制上保持一致并可通过配置追溯。
- 流水线测试覆盖 `internal/agent/...`、`internal/server/...` 并保持全绿，端到端行为通过现有集成测试验证。

## 风险与应对
| 风险 | 影响 | 应对策略 |
|------|------|-----------|
| 类型收紧导致编译错误数量庞大 | 迭代进度延迟 | 先由静态分析工具识别调用点，分层提交，使用 `goimports` 自动修复 |
| 服务拆分引入性能回归 | 响应时间上升 | 在 CI 中加入性能基准测试，提前捕获问题 |
| 文档更新滞后于实现 | 认知偏差、再引入耦合 | 每个阶段结束前必须更新文档，评审时检查 |

## 跟踪与沟通机制
- 每日站会同步阻塞点与依赖。
- 使用看板跟踪各阶段任务，明确负责人。
- 每个阶段结束进行演示与代码走查，确保跨职能团队对变更达成共识。

## 当前状态
- [x] 新建 `architecture-optimization-plan` 分支并输出整体优化与验收计划。
- [x] 阶段一至阶段五全部合并至主干，覆盖率加固已完成。

