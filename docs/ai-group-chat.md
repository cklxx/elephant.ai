# AI 群聊功能

## 概述

AI群聊功能允许多个bot在同一个群聊中进行协调对话，避免互相触发导致的无限循环问题。

## 工作原理

1. **检测多bot场景**：当用户在一个消息中@多个bot时，触发AI群聊模式
2. **轮流回复**：bot按照确定的顺序轮流回复，而不是同时回复
3. **防止循环**：bot之间的消息不会触发自动回复，只有用户的消息才会启动新的对话轮次
4. **消息限制**：每个会话最多10条消息，防止无限对话

## 配置

在配置文件中添加以下配置：

```yaml
channels:
  lark:
    app_id: "cli_your_app_id"
    app_secret: "your_app_secret"
    # AI群聊配置
    ai_chat_bot_ids:
      - "cli_bot1_app_id"
      - "cli_bot2_app_id"
      - "cli_bot3_app_id"
    ai_chat_max_messages: 10  # 可选，默认10
```

## 使用示例

在群聊中：

```
@bot1 @bot2 你们两个讨论一下这个话题
```

bot1会先回复，然后bot2回复，形成有序的对话框。

## 技术实现

### 核心组件

- `AIChatCoordinator`：管理多bot会话状态，协调轮流回复
- `Gateway`修改：检测AI群聊模式，跳过bot消息的自动触发

### 关键流程

1. 用户发送包含多个bot@的消息
2. 每个bot的gateway检测到多bot场景
3. 第一个bot（按ID排序）获得回复权
4. 其他bot等待轮次
5. bot回复后，触发下一个bot回复
6. 达到消息限制或超时后，会话结束

## 注意事项

1. 需要配置所有参与bot的AppID列表
2. 只有被@的bot才会参与对话
3. bot之间的消息不会触发新的回复（防止循环）
4. 会话有消息数量限制，防止无限对话
