ARG GO_PROXY=https://goproxy.cn,direct
ARG GO_SUMDB=sum.golang.google.cn

FROM golang:1.24-alpine AS base

ARG GO_PROXY
ARG GO_SUMDB

RUN apk add --no-cache \
    bash \
    ca-certificates \
    curl \
    gcc \
    git \
    make \
    musl-dev \
    tzdata

ENV GOPROXY=${GO_PROXY} \
    GOSUMDB=${GO_SUMDB}

RUN go install golang.org/x/tools/cmd/goimports@latest \
    github.com/golangci/golangci-lint/cmd/golangci-lint@latest \
    golang.org/x/vuln/cmd/govulncheck@latest

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN chmod +x scripts/*.sh

FROM base AS development
ENV GO_ENV=development
CMD ["./scripts/go-with-toolchain.sh", "run", "./cmd/alex"]

FROM base AS testing
RUN go install gotest.tools/gotestsum@latest
ENV GO_ENV=test
CMD ["./scripts/test.sh", "all"]
