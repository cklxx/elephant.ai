# Development Docker Compose - with hot reload
version: '3.8'

services:
  # ALEX Server - Development mode with volume mount
  alex-server:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.server
    container_name: alex-server-dev
    ports:
      - "8080:8080"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - ARK_API_KEY=${ARK_API_KEY:-}
      - ALEX_SESSION_DATABASE_URL=${ALEX_SESSION_DATABASE_URL:-postgres://alex:alex@auth-db:5432/alex_auth?sslmode=disable}
      - ALEX_WEB_SESSION_DIR=/data/sessions
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET:-dev-secret-change-me}
      - AUTH_DATABASE_URL=${AUTH_DATABASE_URL:-postgres://alex:alex@auth-db:5432/alex_auth?sslmode=disable}
      - AUTH_BOOTSTRAP_PASSWORD=${AUTH_BOOTSTRAP_PASSWORD:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID:-}
      - CLOUDFLARE_ACCESS_KEY_ID=${CLOUDFLARE_ACCESS_KEY_ID:-}
      - CLOUDFLARE_SECRET_ACCESS_KEY=${CLOUDFLARE_SECRET_ACCESS_KEY:-}
      - CLOUDFLARE_BUCKET=${CLOUDFLARE_BUCKET:-}
      - CLOUDFLARE_PUBLIC_BASE_URL=${CLOUDFLARE_PUBLIC_BASE_URL:-}
      - CLOUDFLARE_ATTACHMENT_KEY_PREFIX=${CLOUDFLARE_ATTACHMENT_KEY_PREFIX:-}
      - MOBILE_ADB_ADDRESS=${MOBILE_ADB_ADDRESS:-android-emulator:5555}
    volumes:
      - ../../:/app:cached
      - alex-sessions-dev:/data/sessions
      - ~/.alex/config.yaml:/root/.alex/config.yaml:ro
    working_dir: /app
    command: go run ./cmd/alex-server
    restart: unless-stopped
    depends_on:
      auth-db:
        condition: service_healthy
    networks:
      - alex-dev-network

  # Next.js - Development mode with hot reload
  web:
    build:
      context: ../../web
      dockerfile: Dockerfile.dev
      target: dev
    container_name: alex-web-dev
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NODE_ENV=development
    volumes:
      - ../../web:/app:cached
      - /app/node_modules
      - /app/.next
    command: npm run dev
    restart: unless-stopped
    networks:
      - alex-dev-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: alex-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis-data-dev:/data
    networks:
      - alex-dev-network

  auth-db:
    image: ${AUTH_DB_IMAGE:-postgres:15}
    container_name: alex-auth-db
    environment:
      - POSTGRES_USER=${AUTH_DB_USER:-alex}
      - POSTGRES_PASSWORD=${AUTH_DB_PASSWORD:-alex}
      - POSTGRES_DB=${AUTH_DB_NAME:-alex_auth}
    ports:
      - "${AUTH_DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_DB_USER:-alex} -d ${AUTH_DB_NAME:-alex_auth}"]
      interval: 5s
      retries: 10
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - alex-dev-network

  android-emulator:
    image: ${ANDROID_EMULATOR_IMAGE:-budtmo/docker-android:emulator_11.0}
    container_name: alex-android-emulator
    ports:
      - "5555:5555"
      - "6080:6080"
    environment:
      - WEB_VNC=true
      - EMULATOR_DEVICE=${ANDROID_EMULATOR_DEVICE:-Samsung Galaxy S10}
    privileged: true
    restart: unless-stopped
    networks:
      - alex-dev-network

volumes:
  alex-sessions-dev:
  redis-data-dev:
  auth-db-data:

networks:
  alex-dev-network:
    driver: bridge
