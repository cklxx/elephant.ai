FROM golang:1.25-alpine AS base

RUN apk add --no-cache \
    bash \
    ca-certificates \
    curl \
    gcc \
    git \
    make \
    musl-dev \
    tzdata

RUN go install golang.org/x/tools/cmd/goimports@latest \
    github.com/golangci/golangci-lint/cmd/golangci-lint@latest \
    golang.org/x/vuln/cmd/govulncheck@latest \
    github.com/air-verse/air@latest

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN chmod +x scripts/*.sh

FROM base AS development
ENV GO_ENV=development
CMD ["air", "-c", ".air.toml"]

FROM base AS testing
RUN go install gotest.tools/gotestsum@latest
ENV GO_ENV=test
CMD ["./scripts/test.sh", "all"]
